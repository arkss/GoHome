<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>GoHome Node.js Visualization</title>

	<link rel="stylesheet" href="normalize.min.css">
	<script src="./js.js"></script>
	<script src="./tmap.js"></script>
</head>
<body>
	<div id="map_div"></div>

	<script>
		const base_url = "http://127.0.0.1:8080";

		let iconSize = new Tmapv2.Size(10, 20);

		// 마커들을 저장할 배열입니다.
		let bikeMarkers = [];
		let nbusMarkers = [];
		let routeMarkers = [];

		// 지도가 생성될 div
		let map;

		const getBikeList = () => {
			req(`${base_url}/api/bikeList`)
			.then(res => {
				console.log(res);
				showBikeMarkers(res.data.bikestops);
			})
			.catch(console.log);
		};

		const getNbusInfo = () => {
			req(`${base_url}/api/nbus_info`)
			.then(json => {
				document.body.innerText = JSON.stringify(json, null, 4);
			})
			.catch(console.log);
		};

		const getNearNbusStations = () => {
			req(`${base_url}/api/nbus_near_stations`)
			.then(res => {
				console.log(res);
				showNbusMarkers(res.data.stations);
			})
			.catch(console.log);
		};

		const getRoutes = (lon_start, lat_start, lon_end, lat_end) => {
			req(`${base_url}/api/routes`, 'GET', {
				lon_start: lon_start,
				lat_start: lat_start,
				lon_end: lon_end,
				lat_end: lat_end
			})
			.then(res => {
				console.log(res);
				showRouteMarkers(res.data.routes[0].points);
			})
			.catch(console.log);
		};

		// 페이지가 로딩이 된 후 호출하는 함수입니다.
		const initTmap = () => {
			// map 생성
			// Tmapv2.Map을 이용하여, 지도가 들어갈 div, 넓이, 높이를 설정합니다.
			map = new Tmapv2.Map("map_div", { 
				width : "100vw", height : "100vh"
			});
		};

		const showBikeMarkers = (bikestops) => {
			removeMarkers(bikeMarkers);
			bikeMarkers = [];

			// Marker 객체 생성.
			for (let bikestop of bikestops) {
				var marker = new Tmapv2.Marker({
					position: new Tmapv2.LatLng(bikestop.stationLatitude, bikestop.stationLongitude),
					label: `${bikestop.stationName} (${bikestop.parkingBikeTotCnt}/${bikestop.rackTotCnt})`,
					iconSize: iconSize
				});
				marker.setMap(map);
				bikeMarkers.push(marker);
			}
		};

		const showNbusMarkers = (stations) => {
			removeMarkers(nbusMarkers);
			nbusMarkers = [];

			// Marker 객체 생성.
			for (let station of stations) {
				var marker = new Tmapv2.Marker({
					position: new Tmapv2.LatLng(station.gpsY, station.gpsX),
					label: `N[${station.stationNm}]`,
					iconSize: iconSize
				});
				marker.setMap(map);
				nbusMarkers.push(marker);
			}
		};

		const showRouteMarkers = (route) => {
			removeMarkers(routeMarkers);
			routeMarkers = [];

			// Marker 객체 생성.
			let i, point;
			for (i = 0; i < route.length; i++) {
				point = route[i];
				var marker = new Tmapv2.Marker({
					position: new Tmapv2.LatLng(point[1], point[0]),
					label: `R[${i}]`
				});
				marker.setMap(map);
				routeMarkers.push(marker);
			}
		};

		// 모든 마커를 제거하는 함수입니다.
		const removeMarkers = (markers) => {
			for (let marker of markers) {
				marker.setMap(null);
				marker = null;
			}
		};

		window.onload = () => {
			initTmap();
			//getBikeList();
			//getNearNbusStations();
		};
	</script>
</body>
</html>